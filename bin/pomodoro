#!/usr/bin/env node

//     pomodoro-timer
//     Copyright (c) 2013 Nick Baugh <niftylettuce@gmail.com>
//     MIT Licensed

//
// Free Pomodoro® Technique CLI timer built with Node.
//
// The Pomodoro Technique® and Pomodoro™ are
//  registered trademarks of Francesco Cirillo.
//

// * Author: [@niftylettuce](https://twitter.com/#!/niftylettuce)
// * Source: <https://github.com/niftylettuce/pomodoro-timer>

// # pomodoro-timer

var growl    = require('growl')
  , path     = require('path')
  , version  = require('../package').version
  // , play     = require('play').Play()
  , pomodoro = path.join(__dirname, '..', 'assets', 'pomodoro-timer.png')


  , ProgressBar = require('progress')

  , App = require('../src/pomodoro')


function toMinutes(time){
  return parseInt(time / 1000 / 60) + ":" + (time / 1000 % 60)
}

var app = new App()
app.run()

var
now = function(){
  return new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '');
},

timer = function(label){ return function(time){

  var
  times = 0, 
  interval = 30 * 1000,
  total =  toMinutes(time),
  cb = setInterval(function(){
    times++

    console.log("\n| [" + label + '] => ' + toMinutes(times * interval) + ' / ' + total)
  }, interval)

  setTimeout(function(){
    clearInterval(cb)
  }, time)

}},

progressBar = function(label){
  return function(time){
      var
      step = 10 * 1000, //ms
      timeBar = new ProgressBar("|:bar|\n", { 
        total: (time - step)/ step,
        width: 70,
        incomplete: ' ',
        complete: '.',
        clear: true
      });

      timeBar.tick(0);

      setInterval(function(){
        timeBar.tick()
      }, step);
  }
}


app.on('task.start', function(time, task){
  console.log(
              "===========================================================\n" 
              + '# Stating task [' + task + '] at ' + now() + "\n" +
              "==========================================================="
              )
})


app.on('task.start', timer('Task') )
app.on('task.start', progressBar('Task timer'))


app.on('task.timeover.notification', function(timeLeft, task){
  console.log("\n| You have " +  toMinutes(timeLeft) + ' minutes to complete your task!')

  // Growl notification
  growl('Tic tac!', { 
    title: 'You have ' +  toMinutes(timeLeft) + ' minutes to complete your task!', 
    image: pomodoro 
  })
})


app.on('task.timeover', function(task){
  console.log('| Hope you have finished, now you should take a break')
})


app.on('shortBreak.start', function(time){
  console.log('! Starting  short break at ' + now())

  // Growl notification
  growl('Break time starts', { 
    title: 'It\'s time to have a Break!', 
    image: pomodoro 
  })
})

app.on('shortBreak.start', timer('Break'))
app.on('shortBreak.start', progressBar('Break Timer'))

app.on('shortBreak.timeover', function(){
  // Growl notification
  growl('Break Time is over', { 
    title: 'You have to get back to work!', 
    image: pomodoro 
  })

  console.log("\n\n-------------------------")
  console.log("Starting a new Task !")
})

return 
