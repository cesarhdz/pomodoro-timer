#!/usr/bin/env node

//     pomodoro-timer
//     Copyright (c) 2013 Nick Baugh <niftylettuce@gmail.com>
//     MIT Licensed

//
// Free Pomodoro® Technique CLI timer built with Node.
//
// The Pomodoro Technique® and Pomodoro™ are
//  registered trademarks of Francesco Cirillo.
//

// * Author: [@niftylettuce](https://twitter.com/#!/niftylettuce)
// * Source: <https://github.com/niftylettuce/pomodoro-timer>

// # pomodoro-timer

var growl    = require('growl')
  , program  = require('commander')
  , path     = require('path')
  , fs       = require('fs')
  , version  = require('../package').version
  , play     = require('play').Play()
  , pomodoro = path.join(__dirname, '..', 'assets', 'pomodoro-timer.png')
  , start    = path.join(__dirname, '..', 'assets', 'start.wav')
  , done     = path.join(__dirname, '..', 'assets', 'done.wav')


  , ProgressBar = require('progress');

program
  .version(version)
  .option('-m, --mute', 'Mute start and done sounds, played by default', parseInt)
  .option('-t, --time [n]', 'Custom time, defaults to 25 minutes')
  .parse(process.argv)


// Timte to work
program.time = program.time || 25


// After prompting task 
// 
function runTask(){
  program.prompt('task: ', createTask)
}


function playSound(sound){
  if(program.mute){ return }
  
  play.sound(start)
}

function createTask(task) {
  playSound(start);

  growl(task, { title: 'Pomodoro - ' + (program.time )+':00 Remaining', image: pomodoro })

  if(typeof program.time == 'string'){
    program.time = parseInt(program.time)
  }

  displayBar('Running Task', program.time);

  // Set final timeout
  setTimeout(function(){
    startBreak(task);
  }, program.time * 60000)
}

function startBreak(task){
  playSound(done);

  growl(task, { title: 'Pomodoro - Take a break!', image: pomodoro })

  console.log('Pomodoro - Take a break!');
  
  displayBar('Coffe Break', 5);

  setTimeout(function(){
    runTask();
  }, 5  * 60000)
}

function displayBar(task, total){

  var timeBar = new ProgressBar(task + ' [:bar] :percent ', { 
    total: total,
    width: 50,
    incomplete: ' ',
    clear: true
  });

  timeBar.tick(0);

  setInterval(function(){
    timeBar.tick();
  }, 60000);

}

// Bottstrap
runTask();